{% extends 'base.html' %}
{% block content %}

{% include 'side bar.html' %}

<div class="container-fluid px-0 py-4" style="background-color: white;">
  <div class="d-flex justify-content-between align-items-center mb-3 px-3">
    <h3 class="fw-bold">Leave Records</h3>
    <a href="{% url 'apply_leave' request.session.user_id %}" class="btn btn-primary">Add Leave</a>
  </div>

  <div class="table-responsive px-3">
    <div class="d-flex justify-content-end mb-2">
      <input type="text" id="searchInput" class="form-control w-25 me-2" placeholder="Search...">
      <select id="rowsPerPage" class="form-select w-auto">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
      </select>
    </div>

    <table class="table table-bordered table-hover" id="leaveTable">
      <thead style="background-color: #ffffff; color: #000000;">
        <tr>
          <th data-sort="number">S.No.</th>
          <th data-sort="string">Apply Date</th>
          <th data-sort="string">Start Date</th>
          <th data-sort="string">End Date</th>
          <th data-sort="number">Leave Days</th>
          <th>Reason </th>
          <th data-sort="string">Status</th>
          <th data-sort="string">Action By</th>
          <th data-sort="string">Reject leave Reason</th>
        </tr>
      </thead>

      <tbody>
        {% if leave_data %}
        {% for leave in leave_data %}
        <tr id="row-{{ leave.leave_id }}">
          <td>{{ forloop.counter }}</td>
          <td>{{ leave.current_date }}</td>
          <td>{{ leave.start_date }}</td>
          <td>{{ leave.end_date }}</td>
          <td>{{ leave.no_of_leaves }}</td>
          <td id="actions-{{ leave.leave_id }}">
            {{ leave.reason }}
          </td>
          <td id="status-{{ leave.leave_id }}">
            {% if leave.approval_status == 2 %}
              <span class="badge bg-danger">Rejected</span>
            {% elif leave.approval_status == 3 %}
              <span class="badge bg-secondary">Withdrawn</span>
            {% elif leave.approval_status == 4 %}
              <div class="dropdown">
                <span class="badge bg-warning text-dark dropdown-toggle" data-bs-toggle="dropdown" role="button">
                  Pending
                </span>
                {% if today <= leave.start_date %}
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item text-danger" href="#" onclick="updateStatus(event, '{{ leave.leave_id }}', 'Withdrawn')">
                      ↩ Withdraw
                    </a>
                  </li>
                </ul>
                {% endif %}
              </div>
            {% elif leave.approval_status == 1 %}
              <div class="dropdown">
                <span class="badge bg-success dropdown-toggle" data-bs-toggle="dropdown" role="button">
                  Approved
                </span>
                {% if today <= leave.start_date %}
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item text-danger" href="#" onclick="updateStatus(event, '{{ leave.leave_id }}', 'Withdrawn')">
                      ↩ Withdraw
                    </a>
                  </li>
                </ul>
                {% endif %}
              </div>
            {% else %}
              <span class="badge bg-warning text-dark">{{ leave.approval_status.status }}</span>
            {% endif %}
          </td>
          <td id="actionby-{{ leave.leave_id }}">
            {% if leave.approval_status != 4 %}
              {{ leave.approved_by }}
            {% else %}
              Not Assigned
            {% endif %}
          </td>
          <td>{{ leave.approve_reason }}</td>
        </tr>
        {% endfor %}
        {% else %}
        <tr>
          <td colspan="9" class="text-center">No leave records found.</td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <div class="d-flex justify-content-center mt-3">
      <div id="paginationNumbers" class="pagination-numbers"></div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-3 px-2">
      <small id="showingInfo"></small>
      <div>
        <button id="prevPage" class="btn btn-sm btn-outline-dark me-2">Prev</button>
        <button id="nextPage" class="btn btn-sm btn-outline-dark">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
  <div id="successToast" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Leave Withdrawn Successfully!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script>
const table = document.getElementById("leaveTable");
const searchInput = document.getElementById("searchInput");
const rowsPerPageSelect = document.getElementById("rowsPerPage");
const showingInfo = document.getElementById("showingInfo");
const prevBtn = document.getElementById("prevPage");
const nextBtn = document.getElementById("nextPage");
const paginationNumbers = document.getElementById("paginationNumbers");

let currentPage = 1;
let rowsPerPage = parseInt(rowsPerPageSelect.value);

function getFilteredRows() {
  const searchText = searchInput.value.toLowerCase();
  return Array.from(table.querySelectorAll("tbody tr")).filter(row =>
    row.innerText.toLowerCase().includes(searchText)
  );
}

function paginateTable() {
  const filteredRows = getFilteredRows();
  const totalRows = filteredRows.length;
  const totalPages = Math.ceil(totalRows / rowsPerPage);

  if (currentPage > totalPages) currentPage = totalPages || 1;
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;

  table.querySelectorAll("tbody tr").forEach(row => (row.style.display = "none"));
  filteredRows.slice(start, end).forEach(row => (row.style.display = ""));

  showingInfo.innerText = `Showing ${totalRows === 0 ? 0 : start + 1} to ${Math.min(end, totalRows)} of ${totalRows} entries`;
  prevBtn.disabled = currentPage === 1;
  nextBtn.disabled = currentPage >= totalPages;

  renderPageNumbers(totalPages);
}

function renderPageNumbers(totalPages) {
  paginationNumbers.innerHTML = "";
  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement("button");
    btn.innerText = i;
    btn.className = `page-btn btn btn-sm mx-1 ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'}`;
    btn.addEventListener("click", () => {
      currentPage = i;
      paginateTable();
    });
    paginationNumbers.appendChild(btn);
  }
}

function sortTableByColumn(th) {
  const columnIndex = Array.from(th.parentNode.children).indexOf(th);
  const type = th.getAttribute("data-sort");
  const rows = Array.from(table.querySelectorAll("tbody tr"));

  const sortedRows = rows.sort((a, b) => {
    const aText = a.children[columnIndex].innerText.trim();
    const bText = b.children[columnIndex].innerText.trim();
    if (type === "number") return parseFloat(aText) - parseFloat(bText);
    return aText.localeCompare(bText);
  });

  if (th.classList.contains("asc")) {
    sortedRows.reverse();
    th.classList.remove("asc");
    th.classList.add("desc");
  } else {
    th.classList.remove("desc");
    th.classList.add("asc");
  }

  const tbody = table.querySelector("tbody");
  tbody.innerHTML = "";
  sortedRows.forEach(row => tbody.appendChild(row));
  currentPage = 1;
  paginateTable();
}

function updateStatus(event, leaveId, action) {
  event.preventDefault();
  const csrfToken = document.querySelector("meta[name='csrf-token']")?.getAttribute("content");
  if (!csrfToken) {
    console.error("CSRF token not found");
    return;
  }

  fetch("{% url 'update_leave_status' request.session.user_id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": csrfToken,
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: new URLSearchParams({
      "leave_id": leaveId,
      "action": action
    })
  })
  .then(response => {
    if (!response.ok) throw new Error("Failed to update status");
    return response.json();
  })
  .then(data => {
    if (data.status === "Withdrawn") {
      document.getElementById(`status-${leaveId}`).innerHTML = `<span class="badge bg-secondary">Withdrawn</span>`;
      document.getElementById(`actionby-${leaveId}`).innerText = "Self";
      document.getElementById(`actions-${leaveId}`).innerHTML = "-";
      paginateTable();
    }
  })
  .catch(error => {
    console.error("AJAX Error:", error);
  });
}

// Event Listeners
searchInput.addEventListener("input", () => {
  currentPage = 1;
  paginateTable();
});
rowsPerPageSelect.addEventListener("change", () => {
  rowsPerPage = parseInt(rowsPerPageSelect.value);
  currentPage = 1;
  paginateTable();
});
prevBtn.addEventListener("click", () => {
  if (currentPage > 1) {
    currentPage--;
    paginateTable();
  }
});
nextBtn.addEventListener("click", () => {
  currentPage++;
  paginateTable();
});
document.querySelectorAll("th[data-sort]").forEach(th => {
  th.addEventListener("click", () => sortTableByColumn(th));
});

paginateTable();  // Initial load
</script>

<style>
#paginationNumbers {
  display: flex;
  justify-content: center;
  margin-top: 1rem;
}
.page-btn {
  margin: 0 5px;
}
.btn-primary {
  background-color: #007bff;
  border-color: #007bff;
}
.btn-outline-primary {
  border-color: #007bff;
  color: #007bff;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
